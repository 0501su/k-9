package com.fsck.k9.mail.store.imap;


import java.io.IOException;
import java.net.UnknownHostException;

import android.net.ConnectivityManager;

import com.fsck.k9.mail.AuthType;
import com.fsck.k9.mail.AuthenticationFailedException;
import com.fsck.k9.mail.CertificateValidationException;
import com.fsck.k9.mail.CertificateValidationException.Reason;
import com.fsck.k9.mail.ConnectionSecurity;
import com.fsck.k9.mail.K9LibRobolectricTestRunner;
import com.fsck.k9.mail.K9MailLib;
import com.fsck.k9.mail.MessagingException;
import com.fsck.k9.mail.XOAuth2ChallengeParserTest;
import com.fsck.k9.mail.helpers.TestTrustedSocketFactory;
import com.fsck.k9.mail.oauth.OAuth2TokenProvider;
import com.fsck.k9.mail.ssl.TrustedSocketFactory;
import com.fsck.k9.mail.store.imap.mockserver.MockImapServer;
import okio.ByteString;
import org.junit.Before;
import org.junit.Test;
import org.junit.runner.RunWith;
import org.robolectric.shadows.ShadowLog;

import static org.hamcrest.core.StringContains.containsString;
import static org.junit.Assert.assertEquals;
import static org.junit.Assert.assertFalse;
import static org.junit.Assert.assertThat;
import static org.junit.Assert.assertTrue;
import static org.junit.Assert.fail;
import static org.mockito.Mockito.mock;
import static com.fsck.k9.mail.store.imap.ImapConnectionTestUtils.*;


@RunWith(K9LibRobolectricTestRunner.class)
public class ImapConnectionOpenTest {
    private static final boolean DEBUGGING = false;

    private TrustedSocketFactory socketFactory;
    private ConnectivityManager connectivityManager;
    private OAuth2TokenProvider oAuth2TokenProvider;
    private SimpleImapSettings settings;


    @Before
    public void setUp() throws Exception {
        connectivityManager = mock(ConnectivityManager.class);
        oAuth2TokenProvider = createOAuth2TokenProvider();
        socketFactory = TestTrustedSocketFactory.newInstance();

        settings = new SimpleImapSettings();
        settings.setUsername(USERNAME);
        settings.setPassword(PASSWORD);

        if (DEBUGGING) {
            ShadowLog.stream = System.out;
            K9MailLib.setDebug(true);
            K9MailLib.setDebugSensitive(true);
        }
    }

    @Test
    public void open_withNoCapabilitiesInInitialResponse_shouldIssuePreAuthCapabilitiesCommand()
            throws Exception {
        settings.setAuthType(AuthType.PLAIN);
        MockImapServer server = new MockImapServer();
        server.output("* OK example.org server");
        server.expect("1 CAPABILITY");
        server.output("* CAPABILITY IMAP4 IMAP4REV1 AUTH=PLAIN");
        server.output("1 OK CAPABILITY Completed");
        server.expect("2 AUTHENTICATE PLAIN");
        server.output("+");
        server.expect(ByteString.encodeUtf8("\000" + USERNAME + "\000" + PASSWORD).base64());
        server.output("2 OK Success");
        postAuthenticationDialogRequestingCapabilities(server);
        ImapConnection imapConnection = startServerAndCreateImapConnection(server, settings,
                socketFactory, connectivityManager, oAuth2TokenProvider);

        imapConnection.open();

        server.verifyConnectionStillOpen();
        server.verifyInteractionCompleted();
    }

    @Test
    public void open_withCapabilitiesInInitialResponse_shouldNotIssuePreAuthCapabilitiesCommand()
            throws Exception {
        settings.setAuthType(AuthType.PLAIN);
        MockImapServer server = new MockImapServer();
        server.output("* OK [CAPABILITY IMAP4 IMAP4REV1 AUTH=PLAIN]");
        server.expect("1 AUTHENTICATE PLAIN");
        server.output("+");
        server.expect(ByteString.encodeUtf8("\000" + USERNAME + "\000" + PASSWORD).base64());
        server.output("1 OK Success");
        postAuthenticationDialogRequestingCapabilities(server, 2);
        ImapConnection imapConnection = startServerAndCreateImapConnection(server, settings,
                socketFactory, connectivityManager, oAuth2TokenProvider);

        imapConnection.open();

        server.verifyConnectionStillOpen();
        server.verifyInteractionCompleted();
    }

    @Test
    public void open_authPlain() throws Exception {
        settings.setAuthType(AuthType.PLAIN);
        MockImapServer server = new MockImapServer();
        preAuthenticationDialog(server, "AUTH=PLAIN");
        server.expect("2 AUTHENTICATE PLAIN");
        server.output("+");
        server.expect(ByteString.encodeUtf8("\000" + USERNAME + "\000" + PASSWORD).base64());
        server.output("2 OK Success");
        postAuthenticationDialogRequestingCapabilities(server);
        ImapConnection imapConnection = startServerAndCreateImapConnection(server, settings,
                socketFactory, connectivityManager, oAuth2TokenProvider);

        imapConnection.open();

        server.verifyConnectionStillOpen();
        server.verifyInteractionCompleted();
    }

    @Test
    public void open_afterCloseWasCalled_shouldThrow() throws Exception {
        settings.setAuthType(AuthType.PLAIN);
        MockImapServer server = new MockImapServer();
        preAuthenticationDialog(server);
        server.expect("2 LOGIN \"" + USERNAME + "\" \"" + PASSWORD + "\"");
        server.output("2 OK LOGIN completed");
        postAuthenticationDialogRequestingCapabilities(server);
        ImapConnection imapConnection = startServerAndCreateImapConnection(server, settings,
                socketFactory, connectivityManager, oAuth2TokenProvider);
        imapConnection.open();
        imapConnection.close();

        try {
            imapConnection.open();
            fail("Expected exception");
        } catch (IllegalStateException e) {
            assertEquals("open() called after close(). " +
                            "Check wrapped exception to see where close() was called.",
                    e.getMessage());
        }
    }

    @Test
    public void open_authPlainWithLoginDisabled_shouldThrow() throws Exception {
        settings.setAuthType(AuthType.PLAIN);
        MockImapServer server = new MockImapServer();
        preAuthenticationDialog(server, "LOGINDISABLED");
        ImapConnection imapConnection = startServerAndCreateImapConnection(server, settings,
                socketFactory, connectivityManager, oAuth2TokenProvider);

        try {
            imapConnection.open();
            fail("Expected exception");
        } catch (MessagingException e) {
            assertEquals("Server doesn't support unencrypted passwords using AUTH=PLAIN and LOGIN is disabled.",
                    e.getMessage());
        }

        server.verifyConnectionClosed();
        server.verifyInteractionCompleted();
    }

    @Test
    public void open_authPlainWithAuthenticationFailure_shouldFallbackToLogin() throws Exception {
        settings.setAuthType(AuthType.PLAIN);
        MockImapServer server = new MockImapServer();
        preAuthenticationDialog(server, "AUTH=PLAIN");
        server.expect("2 AUTHENTICATE PLAIN");
        server.output("+");
        server.expect(ByteString.encodeUtf8("\000" + USERNAME + "\000" + PASSWORD).base64());
        server.output("2 NO Login Failure");
        server.expect("3 LOGIN \"" + USERNAME + "\" \"" + PASSWORD + "\"");
        server.output("3 OK LOGIN completed");
        postAuthenticationDialogRequestingCapabilities(server, 4);
        ImapConnection imapConnection = startServerAndCreateImapConnection(server, settings,
                socketFactory, connectivityManager, oAuth2TokenProvider);

        imapConnection.open();

        server.verifyConnectionStillOpen();
        server.verifyInteractionCompleted();
    }

    @Test
    public void open_authPlainAndLoginFallbackWithAuthenticationFailure_shouldThrow() throws Exception {
        settings.setAuthType(AuthType.PLAIN);
        MockImapServer server = new MockImapServer();
        preAuthenticationDialog(server, "AUTH=PLAIN");
        server.expect("2 AUTHENTICATE PLAIN");
        server.output("+");
        server.expect(ByteString.encodeUtf8("\000" + USERNAME + "\000" + PASSWORD).base64());
        server.output("2 NO Login Failure");
        server.expect("3 LOGIN \"" + USERNAME + "\" \"" + PASSWORD + "\"");
        server.output("3 NO Go away");
        ImapConnection imapConnection = startServerAndCreateImapConnection(server, settings,
                socketFactory, connectivityManager, oAuth2TokenProvider);

        try {
            imapConnection.open();
            fail("Expected exception");
        } catch (AuthenticationFailedException e) {
            //FIXME: improve exception message
            assertThat(e.getMessage(), containsString("Go away"));
        }

        server.verifyConnectionClosed();
        server.verifyInteractionCompleted();
    }

    @Test
    public void open_authPlainFailureAndDisconnect_shouldThrow() throws Exception {
        settings.setAuthType(AuthType.PLAIN);
        MockImapServer server = new MockImapServer();
        preAuthenticationDialog(server, "AUTH=PLAIN");
        server.expect("2 AUTHENTICATE PLAIN");
        server.output("+");
        server.expect(ByteString.encodeUtf8("\000" + USERNAME + "\000" + PASSWORD).base64());
        server.output("2 NO [UNAVAILABLE] Maximum number of connections from user+IP exceeded");
        server.closeConnection();
        ImapConnection imapConnection = startServerAndCreateImapConnection(server, settings,
                socketFactory, connectivityManager, oAuth2TokenProvider);

        try {
            imapConnection.open();
            fail("Expected exception");
        } catch (NegativeImapResponseException e) {
            assertThat(e.getMessage(), containsString("Maximum number of connections from user+IP exceeded"));
        }

        assertFalse(imapConnection.isConnected());
        server.verifyConnectionClosed();
        server.verifyInteractionCompleted();
    }

    @Test
    public void open_authPlainWithByeResponseAndConnectionClose_shouldThrowAuthenticationFailedException()
            throws Exception {
        settings.setAuthType(AuthType.PLAIN);
        MockImapServer server = new MockImapServer();
        preAuthenticationDialog(server, "AUTH=PLAIN");
        server.expect("2 AUTHENTICATE PLAIN");
        server.output("+");
        server.expect(ByteString.encodeUtf8("\000" + USERNAME + "\000" + PASSWORD).base64());
        server.output("* BYE Go away");
        server.output("2 NO Login Failure");
        server.closeConnection();
        ImapConnection imapConnection = startServerAndCreateImapConnection(server, settings,
                socketFactory, connectivityManager, oAuth2TokenProvider);

        try {
            imapConnection.open();
            fail("Expected exception");
        } catch (AuthenticationFailedException e) {
            //FIXME: improve exception message
            assertThat(e.getMessage(), containsString("Login Failure"));
        }

        server.verifyConnectionClosed();
        server.verifyInteractionCompleted();
    }

    @Test
    public void open_authPlainWithoutAuthPlainCapability_shouldUseLoginMethod() throws Exception {
        settings.setAuthType(AuthType.PLAIN);
        MockImapServer server = new MockImapServer();
        preAuthenticationDialog(server);
        server.expect("2 LOGIN \"" + USERNAME + "\" \"" + PASSWORD + "\"");
        server.output("2 OK LOGIN completed");
        postAuthenticationDialogRequestingCapabilities(server);
        ImapConnection imapConnection = startServerAndCreateImapConnection(server, settings,
                socketFactory, connectivityManager, oAuth2TokenProvider);

        imapConnection.open();

        server.verifyConnectionStillOpen();
        server.verifyInteractionCompleted();
    }

    @Test
    public void open_authCramMd5() throws Exception {
        settings.setAuthType(AuthType.CRAM_MD5);
        MockImapServer server = new MockImapServer();
        preAuthenticationDialog(server, "AUTH=CRAM-MD5");
        server.expect("2 AUTHENTICATE CRAM-MD5");
        server.output("+ " + ByteString.encodeUtf8("<0000.000000000@example.org>").base64());
        server.expect("dXNlciA2ZjdiOTcyYjk5YTI4NDk4OTRhN2YyMmE3MGRhZDg0OQ==");
        server.output("2 OK Success");
        postAuthenticationDialogRequestingCapabilities(server);
        ImapConnection imapConnection = startServerAndCreateImapConnection(server, settings,
                socketFactory, connectivityManager, oAuth2TokenProvider);

        imapConnection.open();

        server.verifyConnectionStillOpen();
        server.verifyInteractionCompleted();
    }

    @Test
    public void open_authCramMd5WithAuthenticationFailure_shouldThrow() throws Exception {
        settings.setAuthType(AuthType.CRAM_MD5);
        MockImapServer server = new MockImapServer();
        preAuthenticationDialog(server, "AUTH=CRAM-MD5");
        server.expect("2 AUTHENTICATE CRAM-MD5");
        server.output("+ " + ByteString.encodeUtf8("<0000.000000000@example.org>").base64());
        server.expect("dXNlciA2ZjdiOTcyYjk5YTI4NDk4OTRhN2YyMmE3MGRhZDg0OQ==");
        server.output("2 NO Who are you?");
        ImapConnection imapConnection = startServerAndCreateImapConnection(server, settings,
                socketFactory, connectivityManager, oAuth2TokenProvider);

        try {
            imapConnection.open();
            fail("Expected exception");
        } catch (AuthenticationFailedException e) {
            //FIXME: improve exception message
            assertThat(e.getMessage(), containsString("Who are you?"));
        }

        server.verifyConnectionClosed();
        server.verifyInteractionCompleted();
    }

    @Test
    public void open_authCramMd5WithoutAuthCramMd5Capability_shouldThrow() throws Exception {
        settings.setAuthType(AuthType.CRAM_MD5);
        MockImapServer server = new MockImapServer();
        preAuthenticationDialog(server, "AUTH=PLAIN");
        ImapConnection imapConnection = startServerAndCreateImapConnection(server, settings,
                socketFactory, connectivityManager, oAuth2TokenProvider);

        try {
            imapConnection.open();
            fail("Expected exception");
        } catch (MessagingException e) {
            assertEquals("Server doesn't support encrypted passwords using CRAM-MD5.", e.getMessage());
        }

        server.verifyConnectionClosed();
        server.verifyInteractionCompleted();
    }

    @Test
    public void open_authXoauthWithSaslIr() throws Exception {
        settings.setAuthType(AuthType.XOAUTH2);
        MockImapServer server = new MockImapServer();
        preAuthenticationDialog(server, "SASL-IR AUTH=XOAUTH AUTH=XOAUTH2");
        server.expect("2 AUTHENTICATE XOAUTH2 " + XOAUTH_STRING);
        server.output("2 OK Success");
        postAuthenticationDialogRequestingCapabilities(server);
        ImapConnection imapConnection = startServerAndCreateImapConnection(server, settings,
                socketFactory, connectivityManager, oAuth2TokenProvider);

        imapConnection.open();

        server.verifyConnectionStillOpen();
        server.verifyInteractionCompleted();
    }

    @Test
    public void open_authXoauthWithSaslIrThrowsExeptionOn401Response() throws Exception {
        settings.setAuthType(AuthType.XOAUTH2);
        MockImapServer server = new MockImapServer();
        preAuthenticationDialog(server, "SASL-IR AUTH=XOAUTH AUTH=XOAUTH2");
        server.expect("2 AUTHENTICATE XOAUTH2 " + XOAUTH_STRING);
        server.output("+ " + XOAuth2ChallengeParserTest.STATUS_401_RESPONSE);
        server.expect("");
        server.output("2 NO SASL authentication failed");
        ImapConnection imapConnection = startServerAndCreateImapConnection(server, settings,
                socketFactory, connectivityManager, oAuth2TokenProvider);

        try {
            imapConnection.open();
            fail();
        } catch (AuthenticationFailedException e) {
            assertEquals("Command: AUTHENTICATE XOAUTH2; response: #2# [NO, SASL authentication failed]",
                    e.getMessage());
        }
    }

    @Test
    public void open_authXoauthWithSaslIrInvalidatesAndRetriesNewTokenOn400Response() throws Exception {
        settings.setAuthType(AuthType.XOAUTH2);
        MockImapServer server = new MockImapServer();
        preAuthenticationDialog(server, "SASL-IR AUTH=XOAUTH AUTH=XOAUTH2");
        server.expect("2 AUTHENTICATE XOAUTH2 " + XOAUTH_STRING);
        server.output("+ " + XOAuth2ChallengeParserTest.STATUS_400_RESPONSE);
        server.expect("");
        server.output("2 NO SASL authentication failed");
        server.expect("3 AUTHENTICATE XOAUTH2 " + XOAUTH_STRING_RETRY);
        server.output("3 OK Success");
        postAuthenticationDialogRequestingCapabilities(server, 4);
        ImapConnection imapConnection = startServerAndCreateImapConnection(server, settings,
                socketFactory, connectivityManager, oAuth2TokenProvider);

        imapConnection.open();

        server.verifyConnectionStillOpen();
        server.verifyInteractionCompleted();
    }

    @Test
    public void open_authXoauthWithSaslIrInvalidatesAndRetriesNewTokenOnInvalidJsonResponse() throws Exception {
        settings.setAuthType(AuthType.XOAUTH2);
        MockImapServer server = new MockImapServer();
        preAuthenticationDialog(server, "SASL-IR AUTH=XOAUTH AUTH=XOAUTH2");
        server.expect("2 AUTHENTICATE XOAUTH2 " + XOAUTH_STRING);
        server.output("+ " + XOAuth2ChallengeParserTest.INVALID_RESPONSE);
        server.expect("");
        server.output("2 NO SASL authentication failed");
        server.expect("3 AUTHENTICATE XOAUTH2 " + XOAUTH_STRING_RETRY);
        server.output("3 OK Success");
        requestCapabilities(server, 4);
        simplePostAuthenticationDialog(server, 5);
        ImapConnection imapConnection = startServerAndCreateImapConnection(server, settings,
                socketFactory, connectivityManager, oAuth2TokenProvider);

        imapConnection.open();

        server.verifyConnectionStillOpen();
        server.verifyInteractionCompleted();
    }

    @Test
    public void open_authXoauthWithSaslIrInvalidatesAndRetriesNewTokenOnMissingStatusJsonResponse() throws Exception {
        settings.setAuthType(AuthType.XOAUTH2);
        MockImapServer server = new MockImapServer();
        preAuthenticationDialog(server, "SASL-IR AUTH=XOAUTH AUTH=XOAUTH2");
        server.expect("2 AUTHENTICATE XOAUTH2 " + XOAUTH_STRING);
        server.output("+ " + XOAuth2ChallengeParserTest.MISSING_STATUS_RESPONSE);
        server.expect("");
        server.output("2 NO SASL authentication failed");
        server.expect("3 AUTHENTICATE XOAUTH2 " + XOAUTH_STRING_RETRY);
        server.output("3 OK Success");
        requestCapabilities(server, 4);
        simplePostAuthenticationDialog(server, 5);
        ImapConnection imapConnection = startServerAndCreateImapConnection(server, settings,
                socketFactory, connectivityManager, oAuth2TokenProvider);

        imapConnection.open();

        server.verifyConnectionStillOpen();
        server.verifyInteractionCompleted();
    }

    @Test
    public void open_authXoauthWithSaslIrWithOldTokenThrowsExceptionIfRetryFails() throws Exception {
        settings.setAuthType(AuthType.XOAUTH2);
        MockImapServer server = new MockImapServer();
        preAuthenticationDialog(server, "SASL-IR AUTH=XOAUTH AUTH=XOAUTH2");
        server.expect("2 AUTHENTICATE XOAUTH2 " + XOAUTH_STRING);
        server.output("+ r3j3krj3irj3oir3ojo");
        server.expect("");
        server.output("2 NO SASL authentication failed");
        server.expect("3 AUTHENTICATE XOAUTH2 " + XOAUTH_STRING_RETRY);
        server.output("+ 433ba3a3a");
        server.expect("");
        server.output("3 NO SASL authentication failed");
        postAuthenticationDialogRequestingCapabilities(server);
        ImapConnection imapConnection = startServerAndCreateImapConnection(server, settings,
                socketFactory, connectivityManager, oAuth2TokenProvider);

        try {
            imapConnection.open();
            fail();
        } catch (AuthenticationFailedException e) {
            assertEquals("Command: AUTHENTICATE XOAUTH2; response: #3# [NO, SASL authentication failed]",
                    e.getMessage());
        }
    }

    @Test
    public void open_authXoauthWithSaslIrParsesCapabilities() throws Exception {
        settings.setAuthType(AuthType.XOAUTH2);
        MockImapServer server = new MockImapServer();
        preAuthenticationDialog(server, "SASL-IR AUTH=XOAUTH AUTH=XOAUTH2");
        server.expect("2 AUTHENTICATE XOAUTH2 " + XOAUTH_STRING);
        server.output("2 OK [CAPABILITY IMAP4REV1 IDLE XM-GM-EXT-1]");
        simplePostAuthenticationDialog(server, 3);
        ImapConnection imapConnection = startServerAndCreateImapConnection(server, settings,
                socketFactory, connectivityManager, oAuth2TokenProvider);

        imapConnection.open();

        server.verifyConnectionStillOpen();
        server.verifyInteractionCompleted();
        assertTrue(imapConnection.hasCapability("XM-GM-EXT-1"));
    }

    @Test
    public void open_authExternal() throws Exception {
        settings.setAuthType(AuthType.EXTERNAL);
        MockImapServer server = new MockImapServer();
        preAuthenticationDialog(server, "AUTH=EXTERNAL");
        server.expect("2 AUTHENTICATE EXTERNAL " + ByteString.encodeUtf8(USERNAME).base64());
        server.output("2 OK Success");
        postAuthenticationDialogRequestingCapabilities(server);
        ImapConnection imapConnection = startServerAndCreateImapConnection(server, settings,
                socketFactory, connectivityManager, oAuth2TokenProvider);

        imapConnection.open();

        server.verifyConnectionStillOpen();
        server.verifyInteractionCompleted();
    }

    @Test
    public void open_authExternalWithAuthenticationFailure_shouldThrow() throws Exception {
        settings.setAuthType(AuthType.EXTERNAL);
        MockImapServer server = new MockImapServer();
        preAuthenticationDialog(server, "AUTH=EXTERNAL");
        server.expect("2 AUTHENTICATE EXTERNAL " + ByteString.encodeUtf8(USERNAME).base64());
        server.output("2 NO Bad certificate");
        ImapConnection imapConnection = startServerAndCreateImapConnection(server, settings,
                socketFactory, connectivityManager, oAuth2TokenProvider);

        try {
            imapConnection.open();
            fail("Expected exception");
        } catch (CertificateValidationException e) {
            //FIXME: improve exception message
            assertThat(e.getMessage(), containsString("Bad certificate"));
        }

        server.verifyConnectionClosed();
        server.verifyInteractionCompleted();
    }

    @Test
    public void open_authExternalWithoutAuthExternalCapability_shouldThrow() throws Exception {
        settings.setAuthType(AuthType.EXTERNAL);
        MockImapServer server = new MockImapServer();
        preAuthenticationDialog(server, "AUTH=PLAIN");
        ImapConnection imapConnection = startServerAndCreateImapConnection(server, settings,
                socketFactory, connectivityManager, oAuth2TokenProvider);

        try {
            imapConnection.open();
            fail("Expected exception");
        } catch (CertificateValidationException e) {
            assertEquals(Reason.MissingCapability, e.getReason());
        }

        server.verifyConnectionClosed();
        server.verifyInteractionCompleted();
    }

    @Test
    public void open_withNoPostAuthCapabilityResponse_shouldIssueCapabilityCommand() throws Exception {
        settings.setAuthType(AuthType.PLAIN);
        MockImapServer server = new MockImapServer();
        preAuthenticationDialog(server, "AUTH=PLAIN");
        server.expect("2 AUTHENTICATE PLAIN");
        server.output("+");
        server.expect(ByteString.encodeUtf8("\000" + USERNAME + "\000" + PASSWORD).base64());
        server.output("2 OK Success");
        server.expect("3 CAPABILITY");
        server.output("* CAPABILITY IDLE");
        server.output("3 OK CAPABILITY Completed");
        simplePostAuthenticationDialog(server, 4);
        ImapConnection imapConnection = startServerAndCreateImapConnection(server, settings,
                socketFactory, connectivityManager, oAuth2TokenProvider);

        imapConnection.open();

        server.verifyConnectionStillOpen();
        server.verifyInteractionCompleted();
        assertTrue(imapConnection.isIdleCapable());
    }

    @Test
    public void open_withUntaggedPostAuthCapabilityResponse_shouldNotIssueCapabilityCommand() throws Exception {
        settings.setAuthType(AuthType.PLAIN);
        MockImapServer server = new MockImapServer();
        preAuthenticationDialog(server, "AUTH=PLAIN");
        server.expect("2 AUTHENTICATE PLAIN");
        server.output("+");
        server.expect(ByteString.encodeUtf8("\000" + USERNAME + "\000" + PASSWORD).base64());
        server.output("* CAPABILITY IMAP4rev1 UNSELECT IDLE QUOTA ID XLIST CHILDREN X-GM-EXT-1 UIDPLUS " +
                "ENABLE MOVE CONDSTORE ESEARCH UTF8=ACCEPT LIST-EXTENDED LIST-STATUS LITERAL- SPECIAL-USE " +
                "APPENDLIMIT=35651584");
        server.output("2 OK");
        simplePostAuthenticationDialog(server, 3);
        ImapConnection imapConnection = startServerAndCreateImapConnection(server, settings,
                socketFactory, connectivityManager, oAuth2TokenProvider);

        imapConnection.open();

        server.verifyConnectionStillOpen();
        server.verifyInteractionCompleted();
        assertTrue(imapConnection.isIdleCapable());
    }

    @Test
    public void open_withPostAuthCapabilityResponse_shouldNotIssueCapabilityCommand() throws Exception {
        settings.setAuthType(AuthType.PLAIN);
        MockImapServer server = new MockImapServer();
        preAuthenticationDialog(server, "AUTH=PLAIN");
        server.expect("2 AUTHENTICATE PLAIN");
        server.output("+");
        server.expect(ByteString.encodeUtf8("\000" + USERNAME + "\000" + PASSWORD).base64());
        server.output("2 OK [CAPABILITY IDLE]");
        simplePostAuthenticationDialog(server, 3);
        ImapConnection imapConnection = startServerAndCreateImapConnection(server, settings,
                socketFactory, connectivityManager, oAuth2TokenProvider);

        imapConnection.open();

        server.verifyConnectionStillOpen();
        server.verifyInteractionCompleted();
        assertTrue(imapConnection.isIdleCapable());
    }

    @Test
    public void open_withNamespaceCapability_shouldIssueNamespaceCommand() throws Exception {
        MockImapServer server = new MockImapServer();
        simplePreAuthAndLoginDialog(server, settings, "NAMESPACE");
        server.expect("3 NAMESPACE");
        server.output("* NAMESPACE ((\"\" \"/\")) NIL NIL");
        server.output("3 OK command completed");
        ImapConnection imapConnection = startServerAndCreateImapConnection(server, settings,
                socketFactory, connectivityManager, oAuth2TokenProvider);

        imapConnection.open();

        server.verifyConnectionStillOpen();
        server.verifyInteractionCompleted();
    }

    @Test
    public void open_withConnectionError_shouldThrow() throws Exception {
        settings.setHost("127.1.2.3");
        settings.setPort(143);
        ImapConnection imapConnection = createImapConnection(
                settings, socketFactory, connectivityManager, oAuth2TokenProvider);

        try {
            imapConnection.open();
            fail("Expected exception");
        } catch (MessagingException e) {
            assertEquals("Cannot connect to host", e.getMessage());
            assertTrue(e.getCause() instanceof IOException);
        }
    }

    @Test
    public void open_withInvalidHostname_shouldThrow() throws Exception {
        settings.setHost("host name");
        settings.setPort(143);
        ImapConnection imapConnection = createImapConnection(
                settings, socketFactory, connectivityManager, oAuth2TokenProvider);

        try {
            imapConnection.open();
            fail("Expected exception");
        } catch (UnknownHostException ignored) {
        }

        assertFalse(imapConnection.isConnected());
    }

    @Test
    public void open_withStartTlsCapability_shouldIssueStartTlsCommand() throws Exception {
        settings.setAuthType(AuthType.PLAIN);
        settings.setConnectionSecurity(ConnectionSecurity.STARTTLS_REQUIRED);
        MockImapServer server = new MockImapServer();
        preAuthenticationDialog(server, "STARTTLS LOGINDISABLED");
        server.expect("2 STARTTLS");
        server.output("2 OK [CAPABILITY IMAP4REV1 NAMESPACE]");
        server.startTls();
        server.expect("3 CAPABILITY");
        server.output("* CAPABILITY IMAP4 IMAP4REV1");
        server.output("3 OK");
        server.expect("4 LOGIN \"" + USERNAME + "\" \"" + PASSWORD + "\"");
        server.output("4 OK [CAPABILITY NAMESPACE] LOGIN completed");
        server.expect("5 NAMESPACE");
        server.output("* NAMESPACE ((\"\" \"/\")) NIL NIL");
        server.output("5 OK command completed");
        ImapConnection imapConnection = startServerAndCreateImapConnection(server, settings,
                socketFactory, connectivityManager, oAuth2TokenProvider);

        imapConnection.open();

        server.verifyConnectionStillOpen();
        server.verifyInteractionCompleted();
    }

    @Test
    public void open_withStartTlsButWithoutStartTlsCapability_shouldThrow() throws Exception {
        settings.setConnectionSecurity(ConnectionSecurity.STARTTLS_REQUIRED);
        MockImapServer server = new MockImapServer();
        preAuthenticationDialog(server);
        ImapConnection imapConnection = startServerAndCreateImapConnection(server, settings,
                socketFactory, connectivityManager, oAuth2TokenProvider);

        try {
            imapConnection.open();
            fail("Expected exception");
        } catch (CertificateValidationException e) {
            //FIXME: CertificateValidationException seems wrong
            assertEquals("STARTTLS connection security not available", e.getMessage());
        }

        server.verifyConnectionClosed();
        server.verifyInteractionCompleted();
    }

    @Test
    public void open_withNegativeResponseToStartTlsCommand_shouldThrow() throws Exception {
        settings.setAuthType(AuthType.PLAIN);
        settings.setConnectionSecurity(ConnectionSecurity.STARTTLS_REQUIRED);
        MockImapServer server = new MockImapServer();
        preAuthenticationDialog(server, "STARTTLS");
        server.expect("2 STARTTLS");
        server.output("2 NO");
        ImapConnection imapConnection = startServerAndCreateImapConnection(server, settings,
                socketFactory, connectivityManager, oAuth2TokenProvider);

        try {
            imapConnection.open();
            fail("Expected exception");
        } catch (NegativeImapResponseException e) {
            assertEquals(e.getMessage(), "Command: STARTTLS; response: #2# [NO]");
        }

        server.verifyConnectionClosed();
        server.verifyInteractionCompleted();
    }

    @Test
    public void open_withCompressDeflateCapability_shouldEnableCompression() throws Exception {
        settings.setUseCompression(true);
        MockImapServer server = new MockImapServer();
        simplePreAuthAndLoginDialog(server, settings, "COMPRESS=DEFLATE");
        server.expect("3 COMPRESS DEFLATE");
        server.output("3 OK");
        server.enableCompression();
        simplePostAuthenticationDialog(server, 4);
        ImapConnection imapConnection = startServerAndCreateImapConnection(server, settings,
                socketFactory, connectivityManager, oAuth2TokenProvider);

        imapConnection.open();

        server.verifyConnectionStillOpen();
        server.verifyInteractionCompleted();
    }

    @Test
    public void open_withNegativeResponseToCompressionCommand_shouldContinue() throws Exception {
        settings.setAuthType(AuthType.PLAIN);
        settings.setUseCompression(true);
        MockImapServer server = new MockImapServer();
        simplePreAuthAndLoginDialog(server, settings, "COMPRESS=DEFLATE");
        server.expect("3 COMPRESS DEFLATE");
        server.output("3 NO");
        simplePostAuthenticationDialog(server, 4);
        ImapConnection imapConnection = startServerAndCreateImapConnection(server, settings,
                socketFactory, connectivityManager, oAuth2TokenProvider);

        imapConnection.open();

        server.verifyConnectionStillOpen();
        server.verifyInteractionCompleted();
    }

    @Test
    public void open_withIoExceptionDuringCompressionCommand_shouldThrow() throws Exception {
        settings.setAuthType(AuthType.PLAIN);
        settings.setUseCompression(true);
        MockImapServer server = new MockImapServer();
        simplePreAuthAndLoginDialog(server, settings, "COMPRESS=DEFLATE");
        server.expect("3 COMPRESS DEFLATE");
        server.closeConnection();
        ImapConnection imapConnection = startServerAndCreateImapConnection(server, settings,
                socketFactory, connectivityManager, oAuth2TokenProvider);

        try {
            imapConnection.open();
            fail("Exception expected");
        } catch (IOException ignored) {
        }

        server.verifyConnectionClosed();
        server.verifyInteractionCompleted();
    }

    @Test
    public void open_withIoExceptionDuringListCommand_shouldThrow() throws Exception {
        settings.setAuthType(AuthType.PLAIN);
        MockImapServer server = new MockImapServer();
        simplePreAuthAndLoginDialog(server, settings, "");
        server.expect("3 LIST \"\" \"\"");
        server.output("* Now what?");
        ImapConnection imapConnection = startServerAndCreateImapConnection(server, settings,
                socketFactory, connectivityManager, oAuth2TokenProvider);

        try {
            imapConnection.open();
            fail("Exception expected");
        } catch (IOException ignored) {
        }

        server.verifyConnectionClosed();
        server.verifyInteractionCompleted();
    }

    @Test
    public void open_withNegativeResponseToListCommand() throws Exception {
        settings.setAuthType(AuthType.PLAIN);
        MockImapServer server = new MockImapServer();
        simplePreAuthAndLoginDialog(server, settings, "");
        server.expect("3 LIST \"\" \"\"");
        server.output("3 NO");
        ImapConnection imapConnection = startServerAndCreateImapConnection(server, settings,
                socketFactory, connectivityManager, oAuth2TokenProvider);

        imapConnection.open();

        server.verifyConnectionStillOpen();
        server.verifyInteractionCompleted();
    }

}
